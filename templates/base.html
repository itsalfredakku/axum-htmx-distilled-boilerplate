<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <title>{% block title %}Axum HTMX App{% endblock %}</title>

    <!-- Design System Tokens -->
    {% include "components/_tokens.html" %}

    <!-- Vendored CSS — no external CDN, no remote fonts -->
    <link href="/static/css/app.css" rel="stylesheet">
    <!-- Vendored icons — served from local fonts/ directory -->
    <link href="/static/css/bootstrap-icons.min.css" rel="stylesheet">

    <style>
        html, body { height: 100%; overflow: hidden; }

        .app-wrapper { display: flex; height: 100vh; overflow: hidden; }

        /* ── CSS-only sidebar toggle (checkbox hack) ── */
        #sidebar-state { display: none; }
        #sidebar-state:checked ~ .app-wrapper .sidebar { width: 64px; min-width: 64px; }
        #sidebar-state:checked ~ .app-wrapper .sidebar .nav-text { display: none; }
        #sidebar-state:checked ~ .app-wrapper .sidebar .nav-link { justify-content: center; padding: var(--space-3); }
        #sidebar-state:checked ~ .app-wrapper .sidebar .brand-text { display: none; }
        #sidebar-state:checked ~ .app-wrapper .sidebar .sidebar-header { justify-content: center; padding: var(--space-3); }
        #sidebar-state:checked ~ .app-wrapper .sidebar .sidebar-brand { justify-content: center; }
        #sidebar-state:checked ~ .app-wrapper .sidebar .sidebar-footer span { display: none; }
        #sidebar-state:checked ~ .app-wrapper .sidebar .sidebar-nav-section { display: none; }

        /* ── CSS-only theme toggle (checkbox + :has) ── */
        #theme-state { display: none; }

        /* Sidebar */
        .sidebar {
            width: 250px; min-width: 250px; height: 100vh;
            display: flex; flex-direction: column;
            background: var(--color-background);
            border-right: 1px solid var(--color-border);
            transition: width 0.3s, min-width 0.3s;
        }
        .sidebar-header {
            height: 56px; min-height: 56px;
            padding: var(--space-3); border-bottom: 1px solid var(--color-border);
            display: flex; align-items: center; gap: var(--space-3);
        }
        .sidebar-brand {
            display: flex; align-items: center; gap: var(--space-3);
            text-decoration: none; color: inherit; font-weight: 700; font-size: var(--font-size-xl);
        }
        .sidebar-brand:hover { text-decoration: none; color: inherit; }
        .sidebar-brand i { font-size: 1.5rem; color: var(--color-brand); line-height: 1; }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: var(--space-2); }
        .sidebar-nav-section { padding: var(--space-2) var(--space-4) var(--space-1); font-size: var(--font-size-xs); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-foreground-subtle); }
        .sidebar .nav-link {
            display: flex; align-items: center; gap: var(--space-3);
            padding: var(--space-3) var(--space-4); margin-bottom: var(--space-1);
            border-radius: var(--radius-md); color: var(--color-foreground-muted);
            text-decoration: none; font-weight: 500;
            transition: all var(--duration-fast);
        }
        .sidebar .nav-link:hover { background: var(--color-background-muted); color: var(--color-foreground); }
        .sidebar .nav-link.active { background: var(--color-brand); color: white; }
        .sidebar .nav-link i { width: 1.25rem; text-align: center; flex-shrink: 0; font-size: 1rem; line-height: 1; }
        .sidebar-footer { padding: var(--space-3) var(--space-4); border-top: 1px solid var(--color-border); font-size: var(--font-size-xs); color: var(--color-foreground-subtle); }

        /* Main content */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
        .main-header {
            height: 56px; min-height: 56px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 var(--space-4);
            background: var(--color-background);
            border-bottom: 1px solid var(--color-border);
        }
        .main-content { flex: 1; overflow-y: auto; padding: var(--space-6); background: var(--color-background-subtle); }

        /* Toggle label styled as button */
        .toggle-label {
            display: inline-flex; align-items: center; justify-content: center;
            width: 36px; height: 36px; cursor: pointer;
            border-radius: var(--radius-md); border: 1px solid var(--color-border);
            background: var(--color-background); color: var(--color-foreground-muted);
            transition: all var(--duration-fast);
        }
        .toggle-label:hover { background: var(--color-background-muted); color: var(--color-foreground); }

        /* Theme icon visibility */
        .theme-icon-dark { display: none; }
        .theme-icon-light { display: inline; }
        #theme-state:checked ~ .app-wrapper .theme-icon-dark { display: inline; }
        #theme-state:checked ~ .app-wrapper .theme-icon-light { display: none; }

        /* Stat cards */
        .stat-card { padding: var(--space-4); }

        /* HTMX loading indicator */
        .htmx-indicator { opacity: 0; transition: opacity 0.2s; }
        .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { opacity: 1; }

        /* Skeleton loading */
        .skeleton { background: var(--color-background-muted); border-radius: var(--radius-sm); animation: pulse 2s infinite; }
        .skeleton-text { height: 1rem; width: 60%; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.5; } }

        /* Error toast area */
        #error-toast:empty { display: none; }
        #error-toast { position: fixed; top: var(--space-4); right: var(--space-4); z-index: 1000; max-width: 400px; }

        /* Responsive — show sidebar via toggle on mobile */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            #sidebar-state:checked ~ .app-wrapper .sidebar { display: flex; position: fixed; z-index: 100; width: 250px; min-width: 250px; }
            #sidebar-state:checked ~ .app-wrapper .sidebar .nav-text { display: inline; }
            #sidebar-state:checked ~ .app-wrapper .sidebar .brand-text { display: inline; }
            #sidebar-state:checked ~ .app-wrapper .sidebar .sidebar-footer span { display: inline; }
            #sidebar-state:checked ~ .app-wrapper .sidebar .sidebar-nav-section { display: block; }
            .main-content { padding: var(--space-4); }
        }
    </style>

    <!--
        HTMX — the ONLY JavaScript loaded. Vendored, SRI-pinned.
        If the hash doesn't match, the browser refuses to execute it.
        Zero custom JS. All interactions are HTMX attributes or CSS.
    -->
    <script src="/static/js/htmx.min.js"
            integrity="sha384-wS5l5IKJBvK6sPTKa2WZ1js3d947pvWXbPJ1OmWfEuxLgeHcEbjUUA5i9V5ZkpCw"
            crossorigin="anonymous"></script>

    {% block head %}{% endblock %}
</head>
<!--
    HTMX: automatically send CSRF token on every request.
    The token is injected by the session middleware as a response header.
    HTMX reads it via hx-headers on body.
-->
<body hx-headers='{"X-CSRF-Token": "{{ csrf_token }}"}'>
    <!-- Error toast container (HTMX errors swap here) -->
    <div id="error-toast"></div>

    <!-- CSS-only state checkboxes (hidden, outside app-wrapper so siblings work) -->
    <input type="checkbox" id="sidebar-state" aria-hidden="true">
    <input type="checkbox" id="theme-state" aria-hidden="true">

    <div class="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-brand">
                    <i class="bi bi-shield-lock-fill"></i>
                    <span class="brand-text">Hardened App</span>
                </a>
            </div>
            <nav id="sidebar-nav" class="sidebar-nav" hx-boost="true" hx-target="#page-content" hx-select="#page-content" hx-swap="outerHTML" hx-push-url="true" hx-select-oob="#sidebar-nav">
                <div class="sidebar-nav-section">Navigation</div>
                <a href="/" class="nav-link {% if current_page == "home" %}active{% endif %}">
                    <i class="bi bi-house"></i><span class="nav-text">Home</span>
                </a>
                <a href="/demo" class="nav-link {% if current_page == "demo" %}active{% endif %}">
                    <i class="bi bi-lightning"></i><span class="nav-text">Demo</span>
                </a>
                <a href="/components" class="nav-link {% if current_page == "components" %}active{% endif %}">
                    <i class="bi bi-grid-1x2"></i><span class="nav-text">Components</span>
                </a>
                <div class="sidebar-nav-section" style="margin-top:var(--space-3)">Reference</div>
                <a href="/security" class="nav-link {% if current_page == "security" %}active{% endif %}">
                    <i class="bi bi-shield-check"></i><span class="nav-text">Security</span>
                </a>
                <a href="/about" class="nav-link {% if current_page == "about" %}active{% endif %}">
                    <i class="bi bi-info-circle"></i><span class="nav-text">About</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <span>v0.1.0 &middot; Axum + HTMX</span>
            </div>
        </aside>

        <!-- Main -->
        <div class="main-wrapper">
            <header class="main-header">
                <div style="display:flex;align-items:center;gap:var(--space-2)">
                    <label for="sidebar-state" class="toggle-label" title="Toggle sidebar">
                        <i class="bi bi-list"></i>
                    </label>
                </div>
                <div>
                    <label for="theme-state" class="toggle-label" title="Toggle theme">
                        <i class="bi bi-sun-fill theme-icon-light"></i>
                        <i class="bi bi-moon-fill theme-icon-dark"></i>
                    </label>
                </div>
            </header>
            <main class="main-content" id="main-content">
                <div id="page-content">
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>
    </div>

    {% block scripts %}{% endblock %}

    <!-- Minimal UI interactions — sidebar, theme, CSRF refresh. Fully auditable. -->
    <script src="/static/js/app.js"
            integrity="sha384-b+bbZJfixHr9EKRnnF0MPPmu08m+N+9B2DnJbfEn5RQ6lhbwNIAixtrbTdHN35+c"
            crossorigin="anonymous"></script>
</body>
</html>
